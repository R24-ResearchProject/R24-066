<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Defect Details</title>
    <link rel="stylesheet" href="../static/styles.css">
</head>
<body>

<div class="container">
    <h1>Daily Defect Details</h1>
    <div class="input-group">
        <label for="workerId">Worker ID</label>
        <input type="text" id="workerId" placeholder="W_XXXXX" required>
    </div>

    <div class="input-group">
        <label for="defect1">Run Off</label>
        <input type="number" id="defect1" min="0" placeholder="0" required>
    </div>

    <div class="input-group">
        <label for="defect2">Open Seam</label>
        <input type="number" id="defect2" min="0" placeholder="0" required>
    </div>

    <div class="input-group">
        <label for="defect3">SPI Error</label>
        <input type="number" id="defect3" min="0" placeholder="0" required>
    </div>

    <div class="input-group">
        <label for="defect4">High Low</label>
        <input type="number" id="defect4" min="0" placeholder="0" required>
    </div>

    <div class="input-group">
        <label for="productionVolume">Production Count</label>
        <input type="number" id="productionVolume" min="0" placeholder="0" required>
    </div>

    <div class="input-group">
        <label for="shift">Shift</label>
        <select id="shift" required>
            <option value="Morning">Morning</option>
            <option value="Afternoon">Afternoon</option>
            <option value="Night">Night</option>
        </select>
    </div>

    <div class="input-group">
        <label for="date">Date</label>
        <input type="date" id="date" required>
    </div>

    <div class="button-group">
        <button onclick="submitData()" class="btn btn-primary">Submit</button>
        <button onclick="resetFields()" class="btn btn-secondary">Reset</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const dateInput = document.getElementById("date");
        const workerIdInput = document.getElementById("workerId");

        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);

        const todayStr = today.toISOString().split('T')[0];
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        dateInput.setAttribute("min", yesterdayStr);
        dateInput.setAttribute("max", todayStr);

        workerIdInput.addEventListener("input", function() {
            const regex = /^W_\d{5}$/;
            if (!regex.test(workerIdInput.value)) {
                workerIdInput.setCustomValidity("Worker ID must follow the format W_XXXXX where XXXXX are digits.");
            } else {
                workerIdInput.setCustomValidity("");
            }
        });
    });

    function submitData() {
        const workerId = document.getElementById('workerId').value;
        const defect1 = document.getElementById('defect1').value;
        const defect2 = document.getElementById('defect2').value;
        const defect3 = document.getElementById('defect3').value;
        const defect4 = document.getElementById('defect4').value;
        const productionVolume = document.getElementById('productionVolume').value;
        const date = document.getElementById('date').value;
        const shift = document.getElementById('shift').value;

        const totalDefects = parseInt(defect1) + parseInt(defect2) + parseInt(defect3) + parseInt(defect4);
        const count = parseInt(productionVolume) - totalDefects;

        const data = {
            workerId,
            defect1,
            defect2,
            defect3,
            defect4,
            productionVolume,
            date,
            shift,
            defect_count: totalDefects,
            count
        };

        console.log('Data being sent:', JSON.stringify(data));

        fetch('http://localhost:30000/api/saveData', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response from server:', data);
            alert(data.message);
        })
        .catch((error) => {
            console.error('Fetch error:', error);
            alert('There was an error saving your data.');
        });
    }

    function resetFields() {
        document.getElementById('workerId').value = '';
        document.getElementById('defect1').value = '';
        document.getElementById('defect2').value = '';
        document.getElementById('defect3').value = '';
        document.getElementById('defect4').value = '';
        document.getElementById('productionVolume').value = '';
        document.getElementById('date').value = '';
        document.getElementById('shift').value = 'Morning';
    }
</script>

</body>
</html>
